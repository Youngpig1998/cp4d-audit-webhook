# CP4D-Audit-Webhook

This webhook looks for pod that has `cp4d-audit: "yes"` label and injects the sidecar container to your pod.

## Preqreqs

1. Install CP4D in`zen` Namespace
2. For OCP 3.11 - The webhook plugins are disabled by default. To enable them please follow the instructions from https://access.redhat.com/solutions/3869391

## Steps to install cp4d-audit-webhook

**Note:** Install only in `zen` namespace.

1. Create a secret named`cp.stg.icr.io` to pull images from staging entitled regsitry.

```shell
kubectl create secret docker-registry  cp.stg.icr.io --docker-server='cp.stg.icr.io' --docker-username='iamapikey' --docker-password='<token>' --docker-email='user@ibm.com'
```

2. oc create -f deploy/audit-webhook-tls-secret.yaml
3. oc create -f deploy/audit-webhook-configmap.yaml
4. oc create -f deploy/audit-webhook-server-service.yaml
5. oc create -f deploy/audit-webhook-server-deployment.yaml
6. oc create -f deploy/audit-mutating-webhook-configuration.yaml

To test this, use the logwriter example

7. oc create -f deploy/example/logwriter.yaml

## To utilize cp4d-audit-webhook

1. Include the label `cp4d-audit: "yes"` in the pod/deployment/statefulset/job type of resource where the audit logs are generated. Inlcude the label in the below mentioned location.
   
   i) For Pod
   
   `.metadata.labels`
   
   iii) For Deployment, StatefulSet, Job
   
   `.spec.template.metadata.labels`
2. Push the audit logs to the volume named `varlog` [like here](deploy/example/logwriter.yaml)
   
   ```yaml
   volumes:
   - name: varlog
       emptyDir: {}
   ```
3. Currently the sidecar image is available only in staging entitled registry, so the above mentioned `cp.stg.icr.io` secret needs to be included in the pod that utilizes webhook.

## To uninstall cp4d-audit-webhook

1. oc delete -f deploy/audit-mutating-webhook-configuration.yaml
2. oc delete -f deploy/audit-webhook-server-deployment.yaml
3. oc delete -f deploy/audit-webhook-server-service.yaml
4. oc delete -f deploy/audit-webhook-configmap.yaml
5. oc delete -f deploy/audit-webhook-tls-secret.yaml

## Log Augmentation and Auditing

The log data generated by the IBM Watson team may not be CloudPak compliant. We compared the public log and private log data and we found the attachments field is missing. So we augment this log field by using the webhook we created.

1. Push your necessary environment variables to the volume named`varlog`[like here](deploy/example/logwriter.yaml)

```yaml
volumes:
  - name: varlog
    emptyDir: {}
```

The environment variables include NAMESPACE, CONTAINERNAME, NODENAME, PODIPADDRESS and CONTAINERID. 
The first four environment variables can be specified in your deployment YAML file. An example is shown in [here](deploy/example/logwriter.yaml). 
CONTAINERID, however, needs to be shared via a directory path. An example is shown in [here](logwriter/writer.sh).
`More details` [Link here](https://github.ibm.com/PrivateCloud-analytics/zen-dev-test-utils/blob/gh-pages/docs/audit-logging.md#adding-system-environment-variables) in here.
They will be written to a EmptyDir that will be picked up by the webhook-injected sidecar container later on.


2. The log data is read by a fluentd in_tail plugin in the sidecar container. It also[augments](fluentd/example.rb) the log with the required audit information, and POST it to the CloudPak zen-audit service.
   More details can be refered[here](fluentd/fluent.conf).

## Getting started with Auditing for Watson Services

1. Watson services should include or enable the audit logs generation logic in all its microservices similar to what it does currently in IBM public cloud. These logs should be written to a file named`serviceName.log` file which should reside in`varlog` mount point.

**Note:** Ideally these logs should be written to a separate file named \<servicename\>.log for each container in a pod. Currently our prototype looks for a single file that is named as `serviceName.log`

2. Include the below`varlog` mount point in your pod template.

```yaml
volumes:
  - name: varlog
    emptyDir: {}
```

3. Support ENABLE_AUDIT flag. The CP4D installation in zen namespace comes with a configmap named `product-configmap`. Watson services should look for ENABLE_AUDIT flag from this configmap and then generate audit logs if it is enabled.

4. Include the label  `cp4d-audit: "yes"` in your [pod template appropriately](#to-utilize-cp4d-audit-webhook) so that the webhook knows to inject the audit sidecar container to your pod.

5. Set the necessary environment variables as [mentioned above](#log-augmentation-and-auditing) in the container spec which generates audit logs. And [print the values of these environment variables to a file](https://github.ibm.com/watson-foundation-services/cp4d-audit-webhook/blob/master/logwriter/writer.sh#L4-L9) named `env` that should reside in the `varlog` mount point. 

6. Install the cp4d-audit-webhook in your cluster following the [above mentioned instrcutions](#steps-to-install-cp4d-audit-webhook)

7. Now deploy the modifield helm chart or operator of the Watson service in zen namespace.

8. Make sure the audit sidecar is injected in the pods where the label `cp4d-audit: "yes"` is set.

9. Check the logs of audit sidecar attached to your pod to verify the audit logs generated by the service container has been submitted to zen audit service. 

